<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Outreach">
    <Require feature="rpc"/>
    <Require feature="views"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
  </head>
  <body>
    <div class="row" ng-controller="MainCtrl">
      <div class="col-md-8">
        <table class="table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Name</th>
              <th>Initiative</th>
              <th>Parry</th>
              <th>Dodge</th>
              <th>Toughness</th>
              <th>Fortitude</th>
              <th>Will</th>
              <th>Condition</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="character in session | orderByPriority | orderBy:'initiative':true">
              <td ng-cloak>{{character.player}}</td>
              <td ng-cloak>{{character.name}}</td>
              <td ng-cloak ng-mouseover="showInitiative=true" ng-mouseleave="showInitiative=false">
                <div ng-show="showInitiative"><input type="number" class="input-sm" ng-model="character.initiative"/></div>
                <div ng-show="showInitiative==false">{{character.initiative}}</div>
              </td>
              <td ng-cloak>{{calculateParry(character)}}</td>
              <td ng-cloak>{{calculateDodge(character)}}</td>
              <td ng-cloak>{{calculateToughness(character)}}</td>
              <td ng-cloak>{{calculateFortitude(character)}}</td>
              <td ng-cloak>{{calculateWill(character)}}</td>
              <td ng-mouseover="showCondition=true" ng-mouseleave="showCondition=false">
                <div ng-show="showCondition"><select  ng-model="character.status.condition" ng-options="c as c for c in conditions | orderBy:'toString()'"></select></div>
                <div ng-show="showCondition==false">{{character.status.condition}}</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-md-4"></div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.9/angular.min.js"></script>
    <script src="//cdn.firebase.com/v0/firebase.js"></script>
    <script src="//cdn.firebase.com/libs/angularfire/0.5.0/angularfire.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script>
       var app = angular.module('app',['firebase']);

 app.controller('MainCtrl', ['$scope','$firebase','orderByPriorityFilter','Character', function($scope, $firebase, orderByPriorityFilter, Character) {
  $scope.characters = $firebase(new Firebase('https://outreach.firebaseio.com/characters'));
  $scope.session = $firebase(new Firebase('https://outreach.firebaseio.com/session'));
  $scope.character = null;
  $scope.editMode = false;
  


  $scope.newCharacter = function() {
    $scope.character = Character.New();
    $scope.editMode = false;
  }

  $scope.newCharacter();

        
  $scope.loadCharacter = function(character) {
    $scope.character = $scope.characters.$child(character[0].$id)
    $scope.editMode = true;
  }
  
  $scope.saveCharacter = function() {
    if($scope.editMode) {
      $scope.character.$save();
      alert($scope.character.name + ' Saved!');
    }
    else
    {
      $scope.characters.$add($scope.character);
      alert($scope.character.name + ' Created!');
    }
  }

  $scope.deleteCharacter = function() {
    if($scope.editMode) {

      if(confirm('Are you sure you want to delete ' + $scope.character.name + '?'))
      {
         $scope.character.$remove();
      }

    }
  }

  $scope.addCharacterToSession = function(){
    $scope.session.$add($scope.character);
  }

}]);

app.factory('Character', function() {
  var Character = {
    New: function() {
      return {
        "initiative":0,
        "status": {
          "bruises": 0,
          "condition":"Normal"
        },
        "defenses" : {
          "fortitude" : {
            "rank" : "0",
            "base" : "stamina"
          },
          "will" : {
            "rank" : "0",
            "base" : "awareness"
          },
          "parry" : {
            "rank" : "0",
            "base" : "fighting"
          },
          "dodge" : {
            "rank" : "0",
            "base" : "agility"
          },
          "toughness" : {
            "rank" : "0",
            "base" : "stamina"
          }
        },
        "abilities" : {
          "agility" : "0",
          "intelligence" : "0",
          "fighting" : "0",
          "strength" : "0",
          "presence" : "0",
          "dexterity" : "0",
          "awareness" : "0",
          "stamina" : "0"
        },
        "skills" : {
          "insight" : {
            "rank" : "0",
            "base" : "awareness"
          },
          "vehicles" : {
            "rank" : "0",
            "base" : "dexterity"
          },
          "closeCombat" : {
            "rank" : "0",
            "base" : "fighting"
          },
          "acrobatics" : {
            "rank" : "0",
            "base" : "agility"
          },
          "stealth" : {
            "rank" : "0",
            "base" : "agility"
          },
          "rangedCombat" : {
            "rank" : "0",
            "base" : "dexterity"
          },
          "persuasion" : {
            "rank" : "0",
            "base" : "presence"
          },
          "investigation" : {
            "rank" : "0",
            "base" : "intelligence"
          },
          "atheletics" : {
            "rank" : "0",
            "base" : "strength"
          },
          "deception" : {
            "rank" : "0",
            "base" : "presence"
          },
          "treatment" : {
            "rank" : "0",
            "base" : "intelligence"
          },
          "intimidation" : {
            "rank" : "0",
            "base" : "presence"
          },
          "perception" : {
            "rank" : "0",
            "base" : "awareness"
          },
          "technology" : {
            "rank" : "0",
            "base" : "intelligence"
          },
          "sleightOfHand" : {
            "rank" : "0",
            "base" : "dexterity"
          }
        },
        "name" : "",
        "player" : ""
      } 
    }
  }

  return Character;
});

    </script>
    <script>
      gapi.hangout.onApiReady.add(function(eventObj){
      if (eventObj.isApiReady) {
        angular.bootstrap(document, ['OutreachApp']);
        }
      });
    </script>
  </body>
</html>
    ]]>
  </Content>
</Module>
